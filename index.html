<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>地圖標記與路徑記錄</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .marker-panel {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.4);
      color: #fff;
      padding: 8px;
      border-radius: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    .panel-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
    }
    .marker-panel select, 
    .marker-panel input, 
    .marker-panel button { 
      padding:4px 6px; 
      border-radius:5px; 
      border:none; 
      font-size:1rem;
    }
    #markerName { width: 100px; }
    .track-btn { background:#28a745; color:#fff; cursor:pointer; }
    .track-btn.active { background:#dc3545; }
    .file-btn { background:#007bff; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="marker-panel">
    <div class="panel-row">
      <label for="markerColor">顏色:</label>
      <select id="markerColor">
        <option value="red">紅</option>
        <option value="blue">藍</option>
        <option value="green">綠</option>
        <option value="orange">橙</option>
        <option value="violet">紫</option>
      </select>
      <label for="markerName">名稱:</label>
      <input type="text" id="markerName" placeholder="輸入名稱">
    </div>
    <div class="panel-row">
      <button id="trackBtn" class="track-btn">開始記錄</button>
      <button id="saveBtn" class="file-btn">存檔 GPX</button>
      <input type="file" id="loadFile" accept=".gpx" style="display:none">
      <button id="loadBtn" class="file-btn">讀檔 GPX</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').fitWorld();

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    map.locate({setView: true, maxZoom: 16});

    // 標記顏色
    const colorIcons = {
      red: new L.Icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",iconSize:[32,32]}),
      blue: new L.Icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",iconSize:[32,32]}),
      green: new L.Icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png",iconSize:[32,32]}),
      orange: new L.Icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png",iconSize:[32,32]}),
      violet: new L.Icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/purple-dot.png",iconSize:[32,32]})
    };

    // 點擊新增標記
    map.on('contextmenu', e => {
      const color = document.getElementById("markerColor").value;
      const name = document.getElementById("markerName").value || "未命名";
      L.marker(e.latlng, {icon: colorIcons[color]}).addTo(map).bindPopup(name).openPopup();
    });

    // =============== 路徑記錄 ===============
    let tracking = false;
    let trackPoints = [];
    let trackLine = null;

    const trackBtn = document.getElementById("trackBtn");
    trackBtn.addEventListener("click", () => {
      tracking = !tracking;
      if(tracking) {
        trackPoints = [];
        if(trackLine) { map.removeLayer(trackLine); trackLine = null; }
        trackBtn.textContent = "停止記錄";
        trackBtn.classList.add("active");
      } else {
        trackBtn.textContent = "開始記錄";
        trackBtn.classList.remove("active");
      }
    });

    map.on('locationfound', e => {
      if(tracking) {
        trackPoints.push([e.latitude, e.longitude]);
        if(trackLine) map.removeLayer(trackLine);
        trackLine = L.polyline(trackPoints, {color:"red"}).addTo(map);
      }
    });
    map.on('locationerror', e => alert("定位失敗: " + e.message));
    setInterval(()=>map.locate({setView:false}),5000);

    // =============== 存檔 GPX ===============
    function saveGPX(points) {
      if(points.length < 2) { alert("沒有足夠的路徑可存檔"); return; }
      let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Leaflet-GPX" xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>記錄路徑</name><trkseg>`;
      points.forEach(p => {
        gpx += `<trkpt lat="${p[0]}" lon="${p[1]}"></trkpt>\n`;
      });
      gpx += `</trkseg></trk></gpx>`;

      const blob = new Blob([gpx], {type: "application/gpx+xml"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "track.gpx";
      a.click();
      URL.revokeObjectURL(url);
    }
    document.getElementById("saveBtn").addEventListener("click", ()=>saveGPX(trackPoints));

    // =============== 讀檔 GPX ===============
    document.getElementById("loadBtn").addEventListener("click", ()=>{
      document.getElementById("loadFile").click();
    });
    document.getElementById("loadFile").addEventListener("change", function(){
      const file = this.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const text = e.target.result;
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "application/xml");
        const trkpts = xml.getElementsByTagName("trkpt");
        let pts = [];
        for(let i=0;i<trkpts.length;i++){
          let lat = parseFloat(trkpts[i].getAttribute("lat"));
          let lon = parseFloat(trkpts[i].getAttribute("lon"));
          pts.push([lat,lon]);
        }
        if(pts.length>1) {
          L.polyline(pts, {color:"blue"}).addTo(map);
          map.fitBounds(pts);
        } else {
          alert("GPX 檔沒有有效的路徑");
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
