<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>GPS 地圖紀錄</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; }
    #controls {
      padding: 5px;
      font-size: 14px;
    }
    select, input, button {
      margin: 3px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <!-- 第一行：標記顏色 + 名稱 -->
    <label>顏色：
      <select id="color">
        <option value="red">紅色</option>
        <option value="blue">藍色</option>
        <option value="green">綠色</option>
        <option value="orange">橘色</option>
        <option value="purple">紫色</option>
      </select>
    </label>
    <label>名稱：
      <input type="text" id="markerName" placeholder="輸入名稱">
    </label>
    <!-- 第二行：操作按鈕 -->
    <div>
      <button onclick="startStopTrack()">開始記錄</button>
      <button onclick="saveGPX()">存 GPX</button>
      <input type="file" id="gpxFile" accept=".gpx" onchange="loadGPX(event)">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0"></script>

  <script>
    let map = L.map('map').setView([23.5, 121], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap 貢獻者'
    }).addTo(map);

    let userMarker;
    let tracking = false;
    let currentTrack = [];
    let trackLayer = L.polyline([], { color: 'blue' }).addTo(map);

    // ---- 定位 ----
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const latlng = [lat, lng];

          if (!userMarker) {
            userMarker = L.marker(latlng).addTo(map).bindPopup("目前位置");
            map.setView(latlng, 16);
          } else {
            userMarker.setLatLng(latlng);
          }

          if (tracking) {
            currentTrack.push(latlng);
            trackLayer.setLatLngs(currentTrack);
          }
        },
        err => {
          console.error("定位失敗：", err.message);
          alert("定位失敗：" + err.message);
        },
        {
          enableHighAccuracy: true,   // 優先用 GPS
          timeout: 20000,             // 最多等 20 秒
          maximumAge: 0               // 不要用快取
        }
      );
    } else {
      alert("此瀏覽器不支援定位功能");
    }

    // ---- 長按新增標記 ----
    map.on('contextmenu', function (e) {
      const color = document.getElementById("color").value;
      const name = document.getElementById("markerName").value || "標記";
      const marker = L.circleMarker(e.latlng, {
        color: color,
        radius: 8
      }).addTo(map);
      marker.bindPopup(`<b>${name}</b>`);
    });

    // ---- 開始/停止記錄 ----
    function startStopTrack() {
      tracking = !tracking;
      if (tracking) {
        currentTrack = [];
        trackLayer.setLatLngs([]);
        document.querySelector("button").innerText = "停止記錄";
      } else {
        document.querySelector("button").innerText = "開始記錄";
      }
    }

    // ---- 匯出 GPX ----
    function saveGPX() {
      if (currentTrack.length === 0) {
        alert("沒有軌跡可存檔！");
        return;
      }

      let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Leaflet">
<trk><name>Track</name><trkseg>`;
      currentTrack.forEach(pt => {
        gpx += `<trkpt lat="${pt[0]}" lon="${pt[1]}"></trkpt>\n`;
      });
      gpx += `</trkseg></trk></gpx>`;

      const blob = new Blob([gpx], { type: "application/gpx+xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "track.gpx";
      a.click();
    }

    // ---- 匯入 GPX ----
    function loadGPX(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(e.target.result, "text/xml");
        const geojson = toGeoJSON.gpx(xml);
        L.geoJSON(geojson, { style: { color: "red" } }).addTo(map);
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
